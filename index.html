import React, { useState, useEffect } from 'react';

const DailySiteReport = () => {
  // State management
  const [activeTab, setActiveTab] = useState('activity');
  const [expandedSections, setExpandedSections] = useState({
    overview: true,
    'activity-details': true,
    'work-details': true,
    manpower: false,
    materials: false,
    photos: false,
    remarks: false
  });
  
  const [dailyActivities, setDailyActivities] = useState([]);
  const [photos, setPhotos] = useState({ 1: null, 2: null });
  const [message, setMessage] = useState({ text: '', type: '' });
  const [currentTime, setCurrentTime] = useState(new Date());

  // Form data states
  const [overviewData, setOverviewData] = useState({
    projectName: '',
    customProjectName: '',
    siteSupervisor: '',
    workShift: '',
    weatherCondition: '',
    siteConditions: ''
  });

  const [activityData, setActivityData] = useState({
    startTime: '',
    endTime: '',
    location: '',
    specificArea: '',
    locationDetails: '',
    contractor: '',
    workCategory: '',
    workType: '',
    workDescription: '',
    workStatus: '',
    qualityStatus: '',
    workerCount: '',
    supervisorCount: '',
    specialistCount: '',
    equipmentUsed: '',
    equipmentDetails: '',
    materialType: '',
    materialDetails: '',
    activitySafetyRemarks: '',
    activityGeneralRemarks: ''
  });

  // Work type mappings
  const workTypeMap = {
    'Structural': ['Concrete Pouring', 'Reinforcement Installation', 'Formwork Setup', 'Steel Erection', 'Foundation Work'],
    'Mechanical': ['Pipe Installation', 'Valve Installation', 'Pump Installation', 'Equipment Mounting', 'Pressure Testing'],
    'Electrical': ['Cable Installation', 'Panel Installation', 'Lighting Installation', 'Testing & Commissioning'],
    'Plumbing': ['Water Pipe Installation', 'Drainage Installation', 'Fixture Installation', 'Leak Repairs'],
    'HVAC': ['Ductwork Installation', 'AC Unit Installation', 'Ventilation Setup', 'System Testing'],
    'Fire Safety': ['Sprinkler Installation', 'Fire Alarm Setup', 'Smoke Detector Installation', 'System Testing'],
    'Finishes': ['Painting', 'Tiling', 'Flooring Installation', 'Door Installation', 'Window Installation'],
    'Landscaping': ['Excavation', 'Planting', 'Irrigation Setup', 'Paving', 'Site Cleanup'],
    'Testing': ['Quality Inspections', 'Safety Testing', 'Performance Testing', 'Final Inspections'],
    'Maintenance': ['Routine Maintenance', 'Repair Work', 'Equipment Service', 'Cleaning']
  };

  // Initialize start time
  useEffect(() => {
    const now = new Date();
    setActivityData(prev => ({
      ...prev,
      startTime: now.toTimeString().slice(0, 5)
    }));
    
    // Update time every second
    const timer = setInterval(() => setCurrentTime(new Date()), 1000);
    return () => clearInterval(timer);
  }, []);

  // Helper functions
  const showMessage = (text, type) => {
    setMessage({ text, type });
    setTimeout(() => setMessage({ text: '', type: '' }), 4000);
  };

  const toggleSection = (section) => {
    setExpandedSections(prev => ({
      ...prev,
      [section]: !prev[section]
    }));
  };

  const handleOverviewChange = (field, value) => {
    setOverviewData(prev => ({ ...prev, [field]: value }));
  };

  const handleActivityChange = (field, value) => {
    setActivityData(prev => ({ ...prev, [field]: value }));
  };

  const handlePhotoUpload = (photoNum, event) => {
    const file = event.target.files[0];
    if (!file) return;

    if (file.size > 5 * 1024 * 1024) {
      showMessage('❌ Photo too large. Max 5MB allowed.', 'error');
      return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
      setPhotos(prev => ({
        ...prev,
        [photoNum]: {
          data: e.target.result,
          name: file.name
        }
      }));
      showMessage(`✅ Photo ${photoNum} uploaded!`, 'success');
    };
    reader.readAsDataURL(file);
  };

  const removePhoto = (photoNum) => {
    setPhotos(prev => ({ ...prev, [photoNum]: null }));
    showMessage(`✅ Photo ${photoNum} removed.`, 'success');
  };

  const addActivity = () => {
    const { startTime, location, contractor, workCategory } = activityData;
    
    if (!startTime || !location || !contractor || !workCategory) {
      showMessage('❌ Please fill in Start Time, Location, Contractor, and Work Category', 'error');
      return;
    }

    const activity = {
      id: Date.now(),
      timestamp: new Date().toLocaleString(),
      ...activityData,
      photos: JSON.parse(JSON.stringify(photos))
    };

    setDailyActivities(prev => [...prev, activity]);
    
    // Clear form but keep overview data
    setActivityData({
      startTime: new Date().toTimeString().slice(0, 5),
      endTime: '',
      location: '',
      specificArea: '',
      locationDetails: '',
      contractor: '',
      workCategory: '',
      workType: '',
      workDescription: '',
      workStatus: '',
      qualityStatus: '',
      workerCount: '',
      supervisorCount: '',
      specialistCount: '',
      equipmentUsed: '',
      equipmentDetails: '',
      materialType: '',
      materialDetails: '',
      activitySafetyRemarks: '',
      activityGeneralRemarks: ''
    });
    
    setPhotos({ 1: null, 2: null });
    showMessage('✅ Activity added successfully!', 'success');
  };

  const deleteActivity = (index) => {
    if (window.confirm('❌ Delete this activity?')) {
      setDailyActivities(prev => prev.filter((_, i) => i !== index));
      showMessage('✅ Activity deleted.', 'success');
    }
  };

  const generateCSV = () => {
    const headers = [
      'Date', 'Project', 'Supervisor', 'Shift', 'Weather', 'Site Conditions',
      'Start Time', 'End Time', 'Location', 'Area', 'Location Details',
      'Contractor', 'Work Category', 'Work Type', 'Description', 'Status', 'Quality',
      'Workers', 'Supervisors', 'Specialists', 'Equipment', 'Equipment Details',
      'Material Type', 'Material Details', 'Safety Remarks', 'General Remarks',
      'Photo 1', 'Photo 2', 'Timestamp'
    ];
    
    const finalProject = overviewData.projectName === 'Custom Project' ? 
      overviewData.customProjectName : overviewData.projectName;
    
    const csvRows = dailyActivities.map(activity => [
      new Date().toLocaleDateString(),
      `"${finalProject || ''}"`,
      `"${overviewData.siteSupervisor || ''}"`,
      `"${overviewData.workShift || ''}"`,
      `"${overviewData.weatherCondition || ''}"`,
      `"${overviewData.siteConditions || ''}"`,
      activity.startTime || '',
      activity.endTime || '',
      `"${activity.location || ''}"`,
      `"${activity.specificArea || ''}"`,
      `"${activity.locationDetails || ''}"`,
      `"${activity.contractor || ''}"`,
      `"${activity.workCategory || ''}"`,
      `"${activity.workType || ''}"`,
      `"${(activity.workDescription || '').replace(/"/g, '""')}"`,
      `"${activity.workStatus || ''}"`,
      `"${activity.qualityStatus || ''}"`,
      activity.workerCount || '',
      activity.supervisorCount || '',
      activity.specialistCount || '',
      `"${activity.equipmentUsed || ''}"`,
      `"${(activity.equipmentDetails || '').replace(/"/g, '""')}"`,
      `"${activity.materialType || ''}"`,
      `"${(activity.materialDetails || '').replace(/"/g, '""')}"`,
      `"${(activity.activitySafetyRemarks || '').replace(/"/g, '""')}"`,
      `"${(activity.activityGeneralRemarks || '').replace(/"/g, '""')}"`,
      `"${(activity.photos && activity.photos[1] ? activity.photos[1].name : '')}"`,
      `"${(activity.photos && activity.photos[2] ? activity.photos[2].name : '')}"`,
      `"${activity.timestamp || ''}"`
    ].join(','));
    
    return [headers.join(','), ...csvRows].join('\n');
  };

  const downloadCSV = () => {
    if (dailyActivities.length === 0) {
      showMessage('❌ No activities to export.', 'error');
      return;
    }
    
    try {
      const csvContent = generateCSV();
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      
      const today = new Date().toISOString().split('T')[0];
      const finalProject = overviewData.projectName === 'Custom Project' ? 
        overviewData.customProjectName : overviewData.projectName;
      const projectName = (finalProject || 'Project').replace(/\s+/g, '_');
      
      const fileName = `Daily_Site_Report_${projectName}_${today}.csv`;
      
      link.setAttribute('href', url);
      link.setAttribute('download', fileName);
      link.style.visibility = 'hidden';
      
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      
      setTimeout(() => URL.revokeObjectURL(url), 1000);
      showMessage('✅ CSV downloaded! Share it via your phone.', 'success');
    } catch (error) {
      showMessage('❌ CSV export failed.', 'error');
    }
  };

  // Calculate summary stats
  const totalWorkers = dailyActivities.reduce((sum, activity) => {
    return sum + (parseInt(activity.workerCount) || 0) + 
           (parseInt(activity.supervisorCount) || 0) + 
           (parseInt(activity.specialistCount) || 0);
  }, 0);
  
  const activeContractors = [...new Set(dailyActivities.map(a => a.contractor).filter(c => c))].length;
  
  let totalHours = 0;
  dailyActivities.forEach(activity => {
    if (activity.startTime && activity.endTime) {
      const start = new Date(`2000-01-01T${activity.startTime}`);
      const end = new Date(`2000-01-01T${activity.endTime}`);
      const hours = (end - start) / (1000 * 60 * 60);
      if (hours > 0) totalHours += hours;
    }
  });

  return (
    <div className="max-w-md mx-auto min-h-screen bg-white">
      {/* Header */}
      <div className="bg-gradient-to-r from-blue-800 to-blue-900 text-white p-5 text-center">
        <h1 className="text-xl font-bold mb-2">🏗️ Daily Site Report System</h1>
        <div className="text-sm opacity-90">
          {currentTime.toLocaleDateString()} • {currentTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
        </div>
      </div>
      
      {/* Status Bar */}
      <div className="bg-gradient-to-r from-green-600 to-green-700 text-white p-4 flex justify-between items-center">
        <div>
          <div className="font-semibold">📅 Today's Report</div>
          <div className="text-xs opacity-90">{dailyActivities.length} activities recorded</div>
        </div>
        <div className="text-right text-xs">
          <div className="font-semibold">
            {dailyActivities.length === 0 ? '🟡 In Progress' : 
             dailyActivities.length < 3 ? '🟠 Partial' : '🟢 Ready'}
          </div>
          <div>Data saved in memory</div>
        </div>
      </div>

      {/* Tabs */}
      <div className="flex bg-white border-b-2 border-gray-200 sticky top-0 z-10">
        {[
          { id: 'activity', icon: '📝', label: 'Activity' },
          { id: 'safety', icon: '🛡️', label: 'Safety' },
          { id: 'progress', icon: '📈', label: 'Progress' },
          { id: 'report', icon: '📊', label: 'Report' }
        ].map(tab => (
          <button
            key={tab.id}
            className={`flex-1 p-4 text-sm font-semibold transition-colors ${
              activeTab === tab.id 
                ? 'text-blue-800 bg-blue-50 border-b-3 border-blue-800' 
                : 'text-gray-600 hover:text-blue-600'
            }`}
            onClick={() => setActiveTab(tab.id)}
          >
            {tab.icon} {tab.label}
          </button>
        ))}
      </div>

      {/* Content */}
      <div className="p-5 pb-10">
        {/* Activity Tab */}
        {activeTab === 'activity' && (
          <div>
            {/* Site Overview Section */}
            <div className="bg-white rounded-xl mb-4 shadow-lg border border-gray-200 overflow-hidden">
              <div 
                className="bg-gradient-to-r from-blue-800 to-blue-600 text-white p-4 cursor-pointer flex justify-between items-center"
                onClick={() => toggleSection('overview')}
              >
                <span className="font-semibold">🏗️ Site Overview</span>
                <span className={`transition-transform ${expandedSections.overview ? 'rotate-180' : ''}`}>▼</span>
              </div>
              {expandedSections.overview && (
                <div className="p-5">
                  <div className="mb-4">
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Project</label>
                    <select 
                      value={overviewData.projectName}
                      onChange={(e) => handleOverviewChange('projectName', e.target.value)}
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                    >
                      <option value="">Select Project</option>
                      <option value="ABC Tower Construction">ABC Tower Construction</option>
                      <option value="Office Complex Phase 2">Office Complex Phase 2</option>
                      <option value="Shopping Mall Development">Shopping Mall Development</option>
                      <option value="Custom Project">Custom Project</option>
                    </select>
                  </div>
                  
                  {overviewData.projectName === 'Custom Project' && (
                    <div className="mb-4">
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Custom Project Name</label>
                      <input 
                        type="text"
                        value={overviewData.customProjectName}
                        onChange={(e) => handleOverviewChange('customProjectName', e.target.value)}
                        placeholder="Enter project name..."
                        className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                      />
                    </div>
                  )}
                  
                  <div className="grid grid-cols-2 gap-3 mb-4">
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Site Supervisor</label>
                      <select 
                        value={overviewData.siteSupervisor}
                        onChange={(e) => handleOverviewChange('siteSupervisor', e.target.value)}
                        className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                      >
                        <option value="">Select Supervisor</option>
                        <option value="John Smith">John Smith</option>
                        <option value="Michael Chen">Michael Chen</option>
                        <option value="Sarah Johnson">Sarah Johnson</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Work Shift</label>
                      <select 
                        value={overviewData.workShift}
                        onChange={(e) => handleOverviewChange('workShift', e.target.value)}
                        className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                      >
                        <option value="">Select Shift</option>
                        <option value="Day Shift (7AM-7PM)">Day Shift (7AM-7PM)</option>
                        <option value="Night Shift (7PM-7AM)">Night Shift (7PM-7AM)</option>
                      </select>
                    </div>
                  </div>
                  
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Weather</label>
                      <select 
                        value={overviewData.weatherCondition}
                        onChange={(e) => handleOverviewChange('weatherCondition', e.target.value)}
                        className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                      >
                        <option value="">Select Weather</option>
                        <option value="Sunny">☀️ Sunny</option>
                        <option value="Partly Cloudy">⛅ Partly Cloudy</option>
                        <option value="Cloudy">☁️ Cloudy</option>
                        <option value="Light Rain">🌦️ Light Rain</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Site Conditions</label>
                      <select 
                        value={overviewData.siteConditions}
                        onChange={(e) => handleOverviewChange('siteConditions', e.target.value)}
                        className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                      >
                        <option value="">Select Conditions</option>
                        <option value="Dry and Safe">Dry and Safe</option>
                        <option value="Wet Surfaces">Wet Surfaces</option>
                        <option value="Muddy Areas">Muddy Areas</option>
                      </select>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Activity Details Section */}
            <div className="bg-white rounded-xl mb-4 shadow-lg border border-gray-200 overflow-hidden">
              <div 
                className="bg-gradient-to-r from-blue-800 to-blue-600 text-white p-4 cursor-pointer flex justify-between items-center"
                onClick={() => toggleSection('activity-details')}
              >
                <span className="font-semibold">⏰ Activity Details</span>
                <span className={`transition-transform ${expandedSections['activity-details'] ? 'rotate-180' : ''}`}>▼</span>
              </div>
              {expandedSections['activity-details'] && (
                <div className="p-5">
                  <div className="grid grid-cols-2 gap-3 mb-4">
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Start Time</label>
                      <input 
                        type="time"
                        value={activityData.startTime}
                        onChange={(e) => handleActivityChange('startTime', e.target.value)}
                        className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">End Time</label>
                      <input 
                        type="time"
                        value={activityData.endTime}
                        onChange={(e) => handleActivityChange('endTime', e.target.value)}
                        className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                      />
                    </div>
                  </div>
                  
                  <div className="grid grid-cols-2 gap-3 mb-4">
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Building/Floor</label>
                      <select 
                        value={activityData.location}
                        onChange={(e) => handleActivityChange('location', e.target.value)}
                        className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                      >
                        <option value="">Select Location</option>
                        <option value="Ground Floor">Ground Floor</option>
                        <option value="1st Floor">1st Floor</option>
                        <option value="2nd Floor">2nd Floor</option>
                        <option value="3rd Floor">3rd Floor</option>
                        <option value="Basement 1">Basement 1</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Specific Area</label>
                      <select 
                        value={activityData.specificArea}
                        onChange={(e) => handleActivityChange('specificArea', e.target.value)}
                        className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                      >
                        <option value="">Select Area</option>
                        <option value="North Wing">North Wing</option>
                        <option value="South Wing">South Wing</option>
                        <option value="Central Core">Central Core</option>
                        <option value="Lobby Area">Lobby Area</option>
                      </select>
                    </div>
                  </div>
                  
                  <div className="mb-4">
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Room/Unit Details</label>
                    <input 
                      type="text"
                      value={activityData.locationDetails}
                      onChange={(e) => handleActivityChange('locationDetails', e.target.value)}
                      placeholder="e.g., Room 301, Unit A, Grid Line 5-8"
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Contractor</label>
                    <select 
                      value={activityData.contractor}
                      onChange={(e) => handleActivityChange('contractor', e.target.value)}
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                    >
                      <option value="">Select Contractor</option>
                      <option value="ABC Construction Ltd">ABC Construction Ltd</option>
                      <option value="BuildPro Engineering">BuildPro Engineering</option>
                      <option value="Elite Contractors">Elite Contractors</option>
                      <option value="MegaBuild Corp">MegaBuild Corp</option>
                    </select>
                  </div>
                </div>
              )}
            </div>

            {/* Work Details Section */}
            <div className="bg-white rounded-xl mb-4 shadow-lg border border-gray-200 overflow-hidden">
              <div 
                className="bg-gradient-to-r from-blue-800 to-blue-600 text-white p-4 cursor-pointer flex justify-between items-center"
                onClick={() => toggleSection('work-details')}
              >
                <span className="font-semibold">🔧 Work Details</span>
                <span className={`transition-transform ${expandedSections['work-details'] ? 'rotate-180' : ''}`}>▼</span>
              </div>
              {expandedSections['work-details'] && (
                <div className="p-5">
                  <div className="mb-4">
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Work Category</label>
                    <select 
                      value={activityData.workCategory}
                      onChange={(e) => {
                        handleActivityChange('workCategory', e.target.value);
                        handleActivityChange('workType', ''); // Reset work type
                      }}
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                    >
                      <option value="">Select Category</option>
                      <option value="Structural">Structural Work</option>
                      <option value="Mechanical">Mechanical Work</option>
                      <option value="Electrical">Electrical Work</option>
                      <option value="Plumbing">Plumbing Work</option>
                      <option value="HVAC">HVAC Work</option>
                      <option value="Finishes">Finishes & Fixtures</option>
                    </select>
                  </div>
                  
                  <div className="mb-4">
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Specific Work Type</label>
                    <select 
                      value={activityData.workType}
                      onChange={(e) => handleActivityChange('workType', e.target.value)}
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                      disabled={!activityData.workCategory}
                    >
                      <option value="">Select Work Type</option>
                      {activityData.workCategory && workTypeMap[activityData.workCategory]?.map(type => (
                        <option key={type} value={type}>{type}</option>
                      ))}
                    </select>
                  </div>
                  
                  <div className="mb-4">
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Work Description</label>
                    <textarea 
                      value={activityData.workDescription}
                      onChange={(e) => handleActivityChange('workDescription', e.target.value)}
                      placeholder="Detailed description of work performed..."
                      rows={3}
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none resize-none"
                    />
                  </div>
                  
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Work Status</label>
                      <select 
                        value={activityData.workStatus}
                        onChange={(e) => handleActivityChange('workStatus', e.target.value)}
                        className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                      >
                        <option value="">Select Status</option>
                        <option value="Started">Started</option>
                        <option value="In Progress">In Progress</option>
                        <option value="50% Complete">50% Complete</option>
                        <option value="75% Complete">75% Complete</option>
                        <option value="Completed">Completed</option>
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Quality Status</label>
                      <select 
                        value={activityData.qualityStatus}
                        onChange={(e) => handleActivityChange('qualityStatus', e.target.value)}
                        className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                      >
                        <option value="">Select Quality</option>
                        <option value="Excellent">Excellent</option>
                        <option value="Good">Good</option>
                        <option value="Satisfactory">Satisfactory</option>
                        <option value="Needs Improvement">Needs Improvement</option>
                      </select>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Manpower Section */}
            <div className="bg-white rounded-xl mb-4 shadow-lg border border-gray-200 overflow-hidden">
              <div 
                className="bg-gradient-to-r from-blue-800 to-blue-600 text-white p-4 cursor-pointer flex justify-between items-center"
                onClick={() => toggleSection('manpower')}
              >
                <span className="font-semibold">👥 Manpower & Equipment</span>
                <span className={`transition-transform ${expandedSections.manpower ? 'rotate-180' : ''}`}>▼</span>
              </div>
              {expandedSections.manpower && (
                <div className="p-5">
                  <div className="grid grid-cols-3 gap-3 mb-4">
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Workers</label>
                      <select 
                        value={activityData.workerCount}
                        onChange={(e) => handleActivityChange('workerCount', e.target.value)}
                        className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                      >
                        <option value="">Count</option>
                        {[1,2,3,4,5,6,7,8,9,10,15,20].map(n => (
                          <option key={n} value={n.toString()}>{n}{n === 20 ? '+' : ''}</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Supervisors</label>
                      <select 
                        value={activityData.supervisorCount}
                        onChange={(e) => handleActivityChange('supervisorCount', e.target.value)}
                        className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                      >
                        <option value="">Count</option>
                        {[1,2,3,4].map(n => (
                          <option key={n} value={n.toString()}>{n}</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-semibold text-gray-700 mb-2">Specialists</label>
                      <select 
                        value={activityData.specialistCount}
                        onChange={(e) => handleActivityChange('specialistCount', e.target.value)}
                        className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                      >
                        <option value="">Count</option>
                        {[1,2,3,4].map(n => (
                          <option key={n} value={n.toString()}>{n}</option>
                        ))}
                      </select>
                    </div>
                  </div>
                  
                  <div className="mb-4">
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Equipment Used</label>
                    <select 
                      value={activityData.equipmentUsed}
                      onChange={(e) => handleActivityChange('equipmentUsed', e.target.value)}
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                    >
                      <option value="">Select Equipment</option>
                      <option value="Tower Crane">Tower Crane</option>
                      <option value="Mobile Crane">Mobile Crane</option>
                      <option value="Excavator">Excavator</option>
                      <option value="Concrete Mixer">Concrete Mixer</option>
                      <option value="Scaffold System">Scaffold System</option>
                      <option value="Hand Tools Only">Hand Tools Only</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Equipment Details</label>
                    <textarea 
                      value={activityData.equipmentDetails}
                      onChange={(e) => handleActivityChange('equipmentDetails', e.target.value)}
                      placeholder="Equipment quantities and specifications..."
                      rows={2}
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none resize-none"
                    />
                  </div>
                </div>
              )}
            </div>

            {/* Materials Section */}
            <div className="bg-white rounded-xl mb-4 shadow-lg border border-gray-200 overflow-hidden">
              <div 
                className="bg-gradient-to-r from-blue-800 to-blue-600 text-white p-4 cursor-pointer flex justify-between items-center"
                onClick={() => toggleSection('materials')}
              >
                <span className="font-semibold">📦 Materials Used</span>
                <span className={`transition-transform ${expandedSections.materials ? 'rotate-180' : ''}`}>▼</span>
              </div>
              {expandedSections.materials && (
                <div className="p-5">
                  <div className="mb-4">
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Material Type</label>
                    <select 
                      value={activityData.materialType}
                      onChange={(e) => handleActivityChange('materialType', e.target.value)}
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                    >
                      <option value="">Select Material Type</option>
                      <option value="Concrete">Concrete</option>
                      <option value="Steel/Rebar">Steel/Rebar</option>
                      <option value="Bricks/Blocks">Bricks/Blocks</option>
                      <option value="Electrical Materials">Electrical Materials</option>
                      <option value="Plumbing Materials">Plumbing Materials</option>
                      <option value="No Materials Used">No Materials Used</option>
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Material Details & Quantities</label>
                    <textarea 
                      value={activityData.materialDetails}
                      onChange={(e) => handleActivityChange('materialDetails', e.target.value)}
                      placeholder="Material types, quantities, quality notes..."
                      rows={2}
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none resize-none"
                    />
                  </div>
                </div>
              )}
            </div>

            {/* Photos Section */}
            <div className="bg-white rounded-xl mb-4 shadow-lg border border-gray-200 overflow-hidden">
              <div 
                className="bg-gradient-to-r from-blue-800 to-blue-600 text-white p-4 cursor-pointer flex justify-between items-center"
                onClick={() => toggleSection('photos')}
              >
                <span className="font-semibold">📸 Photos</span>
                <span className={`transition-transform ${expandedSections.photos ? 'rotate-180' : ''}`}>▼</span>
              </div>
              {expandedSections.photos && (
                <div className="p-5">
                  <div className="grid grid-cols-2 gap-4">
                    {[1, 2].map(photoNum => (
                      <div key={photoNum} className="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center bg-gray-50">
                        <label className="block text-sm font-semibold text-gray-700 mb-3">
                          {photoNum === 1 ? 'Before Photo' : 'After Photo'}
                        </label>
                        
                        {photos[photoNum] ? (
                          <div>
                            <img 
                              src={photos[photoNum].data} 
                              alt={`Photo ${photoNum}`}
                              className="w-full h-32 object-cover rounded-lg mb-2"
                            />
                            <div className="text-xs text-gray-600 mb-2">{photos[photoNum].name}</div>
                            <button 
                              onClick={() => removePhoto(photoNum)}
                              className="bg-red-600 text-white px-3 py-1 rounded text-xs font-medium"
                            >
                              Remove
                            </button>
                          </div>
                        ) : (
                          <div>
                            <div className="grid grid-cols-2 gap-2 mb-2">
                              <label className="bg-blue-600 text-white p-2 rounded cursor-pointer text-xs font-medium">
                                📷 Camera
                                <input 
                                  type="file" 
                                  accept="image/*" 
                                  capture="environment"
                                  className="hidden"
                                  onChange={(e) => handlePhotoUpload(photoNum, e)}
                                />
                              </label>
                              <label className="bg-gray-600 text-white p-2 rounded cursor-pointer text-xs font-medium">
                                📁 Gallery
                                <input 
                                  type="file" 
                                  accept="image/*"
                                  className="hidden"
                                  onChange={(e) => handlePhotoUpload(photoNum, e)}
                                />
                              </label>
                            </div>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>

            {/* Remarks Section */}
            <div className="bg-white rounded-xl mb-4 shadow-lg border border-gray-200 overflow-hidden">
              <div 
                className="bg-gradient-to-r from-blue-800 to-blue-600 text-white p-4 cursor-pointer flex justify-between items-center"
                onClick={() => toggleSection('remarks')}
              >
                <span className="font-semibold">💬 Remarks</span>
                <span className={`transition-transform ${expandedSections.remarks ? 'rotate-180' : ''}`}>▼</span>
              </div>
              {expandedSections.remarks && (
                <div className="p-5">
                  <div className="mb-4">
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Safety Notes</label>
                    <textarea 
                      value={activityData.activitySafetyRemarks}
                      onChange={(e) => handleActivityChange('activitySafetyRemarks', e.target.value)}
                      placeholder="Safety observations for this activity..."
                      rows={2}
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none resize-none"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">General Remarks</label>
                    <textarea 
                      value={activityData.activityGeneralRemarks}
                      onChange={(e) => handleActivityChange('activityGeneralRemarks', e.target.value)}
                      placeholder="Other notes and observations..."
                      rows={2}
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none resize-none"
                    />
                  </div>
                </div>
              )}
            </div>

            {/* Add Activity Button */}
            <button 
              onClick={addActivity}
              className="w-full bg-green-600 text-white p-4 rounded-lg font-semibold text-lg mb-4 hover:bg-green-700 transition-colors"
            >
              ➕ Add Activity to Report
            </button>
            
            {/* Message Display */}
            {message.text && (
              <div className={`p-3 rounded-lg text-center font-medium ${
                message.type === 'success' 
                  ? 'bg-green-100 border border-green-400 text-green-700' 
                  : 'bg-red-100 border border-red-400 text-red-700'
              }`}>
                {message.text}
              </div>
            )}
          </div>
        )}

        {/* Safety Tab */}
        {activeTab === 'safety' && (
          <div className="bg-white rounded-xl p-5 shadow-lg border border-gray-200">
            <h3 className="text-lg font-bold text-blue-800 mb-4">🛡️ Daily Safety Status</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Overall Safety Status</label>
                <select className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
                  <option value="">Select Status</option>
                  <option value="Excellent">🟢 Excellent - No Issues</option>
                  <option value="Good">🟡 Good - Minor Issues</option>
                  <option value="Fair">🟠 Fair - Some Concerns</option>
                  <option value="Poor">🔴 Poor - Major Issues</option>
                </select>
              </div>
              
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Safety Officer Present</label>
                  <select className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
                    <option value="">Select</option>
                    <option value="Full Day">Yes - Full Day</option>
                    <option value="Partial Day">Yes - Partial Day</option>
                    <option value="Not Present">No - Not Present</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">PPE Compliance</label>
                  <select className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
                    <option value="">Select Compliance</option>
                    <option value="100%">100% Compliant</option>
                    <option value="95%">95% Compliant</option>
                    <option value="90%">90% Compliant</option>
                    <option value="Below 90%">Below 90%</option>
                  </select>
                </div>
              </div>
              
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">Safety Observations</label>
                <textarea 
                  placeholder="Safety incidents, observations, actions taken..."
                  rows={3}
                  className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none resize-none"
                />
              </div>
            </div>
          </div>
        )}

        {/* Progress Tab */}
        {activeTab === 'progress' && (
          <div className="space-y-4">
            <div className="bg-white rounded-xl p-5 shadow-lg border border-gray-200">
              <h3 className="text-lg font-bold text-blue-800 mb-4">📈 Daily Progress</h3>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Progress Rating</label>
                  <select className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
                    <option value="">Rate Today's Progress</option>
                    <option value="Excellent">🟢 Excellent - Ahead of Schedule</option>
                    <option value="Good">🟡 Good - On Schedule</option>
                    <option value="Fair">🟠 Fair - Minor Delays</option>
                    <option value="Poor">🔴 Poor - Behind Schedule</option>
                  </select>
                </div>
                
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Key Achievements</label>
                  <textarea 
                    placeholder="Major achievements and milestones..."
                    rows={3}
                    className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none resize-none"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Issues & Challenges</label>
                  <textarea 
                    placeholder="Problems encountered and solutions..."
                    rows={3}
                    className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none resize-none"
                  />
                </div>
                
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Tomorrow's Plan</label>
                  <textarea 
                    placeholder="Planned activities for tomorrow..."
                    rows={2}
                    className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none resize-none"
                  />
                </div>
              </div>
            </div>

            <div className="bg-white rounded-xl p-5 shadow-lg border border-gray-200">
              <h3 className="text-lg font-bold text-blue-800 mb-4">🔍 Quality Control</h3>
              <div className="space-y-4">
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Overall Quality</label>
                    <select className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
                      <option value="">Select Quality</option>
                      <option value="Excellent">🟢 Excellent</option>
                      <option value="Good">🟡 Good</option>
                      <option value="Acceptable">🟠 Acceptable</option>
                      <option value="Poor">🔴 Poor</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-semibold text-gray-700 mb-2">Rework Required</label>
                    <select className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none">
                      <option value="">Select Status</option>
                      <option value="No Rework">No Rework Required</option>
                      <option value="Minor Rework">Minor Rework Required</option>
                      <option value="Major Rework">Major Rework Required</option>
                    </select>
                  </div>
                </div>
                
                <div>
                  <label className="block text-sm font-semibold text-gray-700 mb-2">Quality Issues</label>
                  <textarea 
                    placeholder="Quality problems and corrective actions..."
                    rows={2}
                    className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none resize-none"
                  />
                </div>
              </div>
            </div>
          </div>
        )}

        {/* Report Tab */}
        {activeTab === 'report' && (
          <div className="space-y-4">
            <div className="bg-white rounded-xl p-5 shadow-lg border border-gray-200">
              <h3 className="text-lg font-bold text-blue-800 mb-4">📊 Daily Summary</h3>
              <div className="grid grid-cols-2 gap-4 mb-5">
                <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg text-center border border-blue-200">
                  <div className="text-2xl font-bold text-blue-800 mb-1">{dailyActivities.length}</div>
                  <div className="text-xs text-blue-800 font-semibold">Activities</div>
                </div>
                <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg text-center border border-blue-200">
                  <div className="text-2xl font-bold text-blue-800 mb-1">{totalWorkers}</div>
                  <div className="text-xs text-blue-800 font-semibold">Workers</div>
                </div>
                <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg text-center border border-blue-200">
                  <div className="text-2xl font-bold text-blue-800 mb-1">{activeContractors}</div>
                  <div className="text-xs text-blue-800 font-semibold">Contractors</div>
                </div>
                <div className="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-lg text-center border border-blue-200">
                  <div className="text-2xl font-bold text-blue-800 mb-1">{Math.round(totalHours * 10) / 10}</div>
                  <div className="text-xs text-blue-800 font-semibold">Work Hours</div>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-xl p-5 shadow-lg border border-gray-200">
              <h3 className="text-lg font-bold text-blue-800 mb-4">📝 Activities Review</h3>
              <div>
                {dailyActivities.length === 0 ? (
                  <div className="text-center py-10 text-gray-500">
                    <div className="text-4xl mb-4">📝</div>
                    <p>No activities recorded yet.<br />Add activities in the Activity tab first.</p>
                  </div>
                ) : (
                  <div className="space-y-3">
                    {dailyActivities.map((activity, index) => (
                      <div key={activity.id} className="bg-gray-50 border-2 border-gray-200 rounded-xl p-4 relative">
                        <div className="flex justify-between items-center mb-3">
                          <div className="bg-blue-800 text-white px-2 py-1 rounded text-xs font-semibold">
                            {activity.startTime}{activity.endTime ? ` - ${activity.endTime}` : ''}
                          </div>
                          <button 
                            onClick={() => deleteActivity(index)}
                            className="bg-red-600 text-white px-2 py-1 rounded text-xs"
                          >
                            🗑️
                          </button>
                        </div>
                        <div className="text-sm space-y-1">
                          <div><strong>📍</strong> {activity.location}{activity.specificArea ? ` - ${activity.specificArea}` : ''}</div>
                          <div><strong>👷</strong> {activity.contractor}</div>
                          <div><strong>🔧</strong> {activity.workCategory}{activity.workType ? ` - ${activity.workType}` : ''}</div>
                          {activity.workDescription && <div><strong>📝</strong> {activity.workDescription}</div>}
                          {activity.workerCount && <div><strong>👥</strong> {activity.workerCount} workers</div>}
                          {activity.materialType && <div><strong>📦</strong> {activity.materialType}</div>}
                          {activity.workStatus && <div><strong>📊</strong> {activity.workStatus}</div>}
                          {(activity.photos[1] || activity.photos[2]) && (
                            <div className="flex gap-2 mt-3">
                              {activity.photos[1] && (
                                <img src={activity.photos[1].data} alt="Photo 1" className="w-16 h-16 object-cover rounded" />
                              )}
                              {activity.photos[2] && (
                                <img src={activity.photos[2].data} alt="Photo 2" className="w-16 h-16 object-cover rounded" />
                              )}
                            </div>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>

            <div className="bg-white rounded-xl p-5 shadow-lg border border-gray-200">
              <h3 className="text-lg font-bold text-blue-800 mb-4">📤 Export Report</h3>
              <div className="space-y-3">
                <button 
                  onClick={downloadCSV}
                  disabled={dailyActivities.length === 0}
                  className={`w-full p-4 rounded-lg font-semibold ${
                    dailyActivities.length === 0 
                      ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                      : 'bg-green-600 text-white hover:bg-green-700'
                  }`}
                >
                  ⬇️ Download CSV Report
                </button>
                
                <div className="text-center text-sm text-gray-600">
                  {dailyActivities.length === 0 ? 'Add activities to enable export' : 'Ready to export'}
                </div>
                
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 text-blue-800 text-sm">
                  <strong>💡 How to use:</strong><br />
                  1. Download CSV file to your phone<br />
                  2. Share via WhatsApp/Email to your computer<br />
                  3. Open in Excel for further processing
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default DailySiteReport;
